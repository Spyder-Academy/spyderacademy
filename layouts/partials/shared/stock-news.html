{{ $symbol := .symbol }}
{{ $stocks := .Site.Data.stocks.stocks }}
{{ $profile := where $stocks "symbol" $symbol }}

<div class="p-5">
  <div class="container">
    <div id="news-feed" class="row">Scanning the latest news ...</div> 
  </div>
</div>

<script>
    async function fetchRSSFeed(url) {
        const CORS_PROXY = 'https://api.allorigins.win/get?url=';
        const RSS_URL = encodeURIComponent(url);
        const response = await fetch(CORS_PROXY + RSS_URL);
        const data = await response.json();
        const parser = new RSSParser();
        const feed = await parser.parseString(data.contents);
        return feed;
    }

    async function displayRSSFeed() {
        const RSS_URL = 'https://news.google.com/rss/search?q={{ $symbol }}+stock&hl=en-US&gl=US&ceid=US:en';
        try {
            const feed = await fetchRSSFeed(RSS_URL);
            const feedContainer = document.getElementById('news-feed');
            feedContainer.replaceChildren();


            // Sort feed items by pubDate in descending order
            feed.items.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

            feed.items.forEach(item => {
                var title = item.title.split(" - ")[0]
                var source = item.title.split(" - ")[1]
                
                var formattedTimestampStr = new Date(item.pubDate).toLocaleDateString()
                if (item.pubDate != ""){
                  formattedTimestampStr = (new Date(item.pubDate)).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true
                  })

                  formattedTimestampStr += " ET"
                }
                
                const itemElement = document.createElement('div');
                itemElement.className = 'col-md-6 col-sm-12 mb-4';
                itemElement.innerHTML = `
                    <a class="card text-decoration-none h-100" href="${item.link}" target="_blank" style="border-radius: 15px">
                        <div class="card-body">
                            <h5 class="card-title fw-semibold">${title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${source}</h6>
                            <p class="card-text">${formattedTimestampStr}</p>
                        </div>
                    </a>`;
                feedContainer.appendChild(itemElement);
            });
        } catch (error) {
            console.error('Error fetching RSS feed:', error);
        }
    }


    displayRSSFeed();
</script>
