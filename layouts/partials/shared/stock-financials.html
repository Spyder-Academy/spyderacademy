{{ $symbol := .symbol }}
{{ $stocks := .Site.Data.stocks.stocks }}
{{ $profile := where $stocks "symbol" $symbol }}



<div class="container p-0 m-0">
  <div class="content-section row d-none stock_social_row">
      <div class="col-12 d-lg-block">
          <div class="card-body tweet-header bg-dark text-white justify-content-center">
              <h4 class="card-title fw-semibold text-uppercase">FINANCIALS</h4>
          </div>
      </div>
  </div>

  <div class="row pb-3 justify-content-evenly text-center tenq">
    <div class="col-4">
      <div class="card rounded  d-flex h-100">
        <div class="card-body">
            <div class="fs-1" id="financials_cagr">-</div>
            <div class="text-muted" title="Compund Annual Growth Rate">CAGR</div>
        </div>
      </div>
    </div>
    <div class="col-4">
      <div class="card rounded d-flex h-100">
        <div class="card-body">
          <div class="fs-1" id="financials_ltm_gross_margin">-</div>
          <div class="text-muted" title="Trailing 12 Months - Gross Margin">Gross Margin (TTM)</div>
        </div>
      </div>
    </div>
    <div class="col-4">
      <div class="card rounded d-flex  h-100">
        <div class="card-body">
          <div class="fs-1" id="financials_ltm_fcf_margin">-</div>
          <div class="text-muted" title="Trailing 12 Months - Free Cash Flow Margin">Free Cash Flow Net Margin (TTM)</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row pb-3 text-center tenq">
    <div class="col-lg-6 col-12">
      <div class="card rounded">
        <div class="card-title p-3 fw-bold">
          QUARTERLY REVENUE
        </div>
        <div class="card-body">
          <div  id="revenueChart"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 col-12">
      <div class="card rounded">
        <div class="card-title p-3 fw-bold">
          EARNINGS PER SHARE
        </div>
        <div class="card-body">
          <div  id="epsChart"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row pb-3 text-center tenq">
    <div class="col-lg-12 col-12">
      <div class="card rounded">
        <div class="sankey_container card-body justify-content-center" style="width: 1200px; height: 600px; align-items: center; justify-content: center;">
            <div id="sankey_chart" class="d-lg-block d-sm-none" style="width: 100%; height: 600px"></div>
            <img id="sankey_image" class="d-lg-none d-sm-block" style="width: 100%"></img>
        </div>
      </div>
    </div>
  </div>

  <div class="row pb-3">
    <div class="col-12">
      <div class="card rounded">
        <div class="card-body">
          <div class="tradingview-financials-widget-container__widget"></div>
          <script type="application/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-financials.js" async>
            {
              "isTransparent": false,
              "largeChartUrl": "",
              "displayMode": "regular",
              "width": "100%",
              "height": "800",
              "colorTheme": "light",
              "symbol": "{{ $symbol }}",
              "locale": "en"
            }
          </script>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  // Initialize the chart
  var chart = echarts.init(document.getElementById('sankey_chart'));

  // Function to fetch data from the API
  async function fetchData() {
      const response = await fetch('https://us-central1-spyder-academy.cloudfunctions.net/stock_financials?ticker={{$symbol}}');
      const data = await response.json();
      return data["income_statements"][0];
  }

  // Function to process data and set chart options
  async function renderChart() {
    const quarterlyEarnings = await fetchData();

    var product_nodes = quarterlyEarnings.revenue_sources.filter(source => !source.name.includes("Total"));

    product_nodes = product_nodes.map(source => ({
            "name": source.name,
            "value": parseFloat(source.value) || 0,
            "depth": 0,
            "itemStyle": { color: "#0065fe"}, label: {position: "top", color: "#0065fe"},
            "append": {name: "Amount", value: monetize(source.value, quarterlyEarnings.revenue)}
        }))

    product_nodes = product_nodes.reduce((acc, source) => {
      const existingNode = acc.find(node => node.name === source.name);

      if (existingNode) {
          existingNode.value += (parseFloat(source.value)  || 0);
      } 
      else {
          acc.push({
              "name": source.name,
              "value": parseFloat(source.value) || 0,
              "depth": 0,
              "itemStyle": { color: "#0065fe"},
              "label": {position: "top", color: "#0065fe"},
              "append": {name: "Amount", value: monetize(source.value, quarterlyEarnings.revenue)}
          });
      }

      return acc;
    }, []);

    product_nodes = product_nodes.sort((a, b) => b.value - a.value).slice(0, 5);

    function monetize(v, t = 0){
      var pv = v
      v = Math.abs(parseFloat(v) || 0)
      if (v >= 1e9){
        pv = `$${(parseFloat(v)/1e9).toFixed(1)}B`
      }
      else if (v >= 1e6){
        pv = `$${(parseFloat(v)/1e6).toFixed(1)}M`
      }
      else if (v >= 1e3){
        pv = `$${(parseFloat(v)/1e3).toFixed(1)}K`
      }
      else{
        pv = `$${(parseFloat(v)).toFixed(1)}`
      }
      
      if (t == 0){
        return pv
      }
      else{
        var pct = (parseFloat(v)/parseFloat(t))*100
        return `${pv} (${pct.toFixed(1)}%)`
      }
    }

    function get_income_color(v){
      if (v > 0) {return "#2ba02d"}// green
      else {return "#cc0003"}// red
    }

    function get_expense_color(v){
      if (v > 0) {return "#cc0003"}// green
      else {return "#2ba02d"}// red
    }

    function get_node(n, v, d, type){
      const color = (type == "out") ? get_expense_color(v) : get_income_color(v);
      v = parseFloat(v) || 0

      return {
        "name": n, 
        "value": Math.abs(v), 
        "depth": d, 
        "itemStyle": { 
          color: color
        }, 
        "label": {
          position: type == "out" ? "bottom" : "top", 
          align: "center",
          color: color, 
          show: (v != 0 ? true : false)
        }, 
        append: {
          name: "Amount", 
          value: monetize(v, quarterlyEarnings.revenue)
        }  
      }
    }

    function get_link(s, d, v, type){
      var color = ""
      v = (parseFloat(v) || 0)
      if (v == 0){
        color = "transparent"
      }
      else{
        color = (type == "out") ? get_expense_color(v) : get_income_color(v);
      }
      return { 
        "source": s, 
        "target": d, 
        "value": Math.abs(v), 
        "lineStyle": {
          color: color , 
          opacity: 0.5
        } 
      }
    }

    // Extract nodes
    const nodes = [
        ...product_nodes,
        { "name": "1-1", "value": parseFloat(quarterlyEarnings.revenue) * 0.25, depth: 1, itemStyle: { color: "transparent"}, label: {show: false}, emphasis: {label: {show: false}} },
        get_node("Revenue", quarterlyEarnings.revenue, 1, "in"),
        
        { "name": "2-1", "value": parseFloat(quarterlyEarnings.revenue) * 0.15, depth: 2, itemStyle: { color: "transparent"}, label: {show: false} },
        get_node("Gross Profit", quarterlyEarnings.gross_profit, 2, "in"),
        get_node("COGS", quarterlyEarnings.cost_of_revenue, 2, "out"),
        
        { "name": "3-1", "value": parseFloat(quarterlyEarnings.revenue) * 0.10, depth: 3, itemStyle: { color: "transparent"}, label: {show: false} },
        get_node("Operating Income", quarterlyEarnings.operating_income, 3, "in"),
        get_node("Operating Expense", quarterlyEarnings.operating_expense, 3, "out"),
        
        { "name": "4-1", "value": parseFloat(quarterlyEarnings.revenue) * 0, depth: 4, itemStyle: { color: "transparent"}, label: {show: false} },
        get_node("PreTax Income", quarterlyEarnings.ebit, 4, "in"),

        { "name": "5-1", "value": parseFloat(quarterlyEarnings.revenue) * 0.00, depth: 5, itemStyle: { color: "transparent"}, label: {show: false} },
        get_node("Net Income", quarterlyEarnings.net_income, 5, "in"),
        get_node("Tax", quarterlyEarnings.income_tax_expense, 5, "out"),
        get_node("Interest Expense", quarterlyEarnings.interest_expense, 5, "out"),
        get_node("SG&A", quarterlyEarnings.selling_general_and_administrative_expenses, 5, "out"),
        get_node("R&D", quarterlyEarnings.research_and_development, 5, "out"),
        get_node("Other Expenses", quarterlyEarnings.other_expenses, 5, "out"),
    ];


    // Extract links
    var product_links = quarterlyEarnings.revenue_sources.filter(source => !source.name.includes("Total"));
    
    product_links = quarterlyEarnings.revenue_sources.reduce((acc, source) => {
      const existingNode = acc.find(node => node.source === source.name);

      if (existingNode) {
        existingNode.value += (parseFloat(source.value) || 0);
      } else {
        acc.push({
          "source": source.name,
          "target": "Revenue",
          "value": parseFloat(source.value) || 0,
          "lineStyle": {
            "color": "#0065fe",
            "opacity": 0.5
          }
        });
      }

      return acc;
    }, []);

    product_links = product_links.sort((a, b) => b.value - a.value).slice(0, 5);

    // console.log(product_nodes, product_links)

    const links = [
        ...product_links,
        get_link("Revenue", "Gross Profit", quarterlyEarnings.gross_profit, "in"),
        get_link("Gross Profit", "Operating Income", quarterlyEarnings.operating_income, "in"),
        get_link("Gross Profit", "Operating Expense", quarterlyEarnings.operating_expense, "out"),
        get_link("Operating Income", "PreTax Income", quarterlyEarnings.ebit, "in"),
        get_link("PreTax Income", "Net Income", quarterlyEarnings.net_income, "in"),
        get_link("PreTax Income", "Tax", quarterlyEarnings.income_tax_expense, "out"),
        get_link("PreTax Income", "Interest Expense", quarterlyEarnings.interest_expense, "out"),
        get_link("Operating Expense", "SG&A", quarterlyEarnings.selling_general_and_administrative_expenses, "out"),
        get_link("Operating Expense", "R&D", quarterlyEarnings.research_and_development, "out"),
        get_link("Operating Expense", "Other Expenses", quarterlyEarnings.other_expenses, "out"),
        get_link("Revenue", "COGS", quarterlyEarnings.cost_of_revenue, "out"),
    ];

    // console.log("Data Node: ", nodes)
    // console.log("Data Links: ", links)
    // Define the chart options
    var option = {
      "mode": 1,
      "animation": false,
      title: {
        text: `How ${quarterlyEarnings.ticker} Makes Money (${quarterlyEarnings["report_period"]})`,
        left: 'center',
        textStyle: {
          fontSize: 30
        }
      },
      tooltip: {
        trigger: 'item',
        triggerOn: 'mousemove'
      },
      toolbox: {
        feature: {
            saveAsImage: {
                show: true,
                type: 'png',
                title: 'Save Chart - How {{$symbol}} Makes Money',
                name: 'how_{{$symbol}}_makes_money',
            }
        },
        bottom: 0
      },
      
      series: [
        {
          type: 'sankey',
          layout: 'none',
          emphasis: {
            focus: "adjacency",
            label: {
              show: true
            },
            lineStyle: {
              opacity: 0.5
            }
          },
          layoutIterations: 0,
          nodeGap: 50,
          left: 180,
          top: 160,
          bottom: 80,
          right: 180,
          lineStyle: {
            curveness: 0.7,
            color: 'source',
          },
          nodeAlign: 'justify',


          data: nodes,
          links: links,
          label: {
            formatter: function(params) {
              const name = params.name;
              const append = params.data.append;

              if (append !== undefined){
                return [
                    `${name}`,
                    `{append|${append.value}}`
                ].join("\n")
              }
              else{
                return `${name}`
              }
            },
            rich: {
              append: {
                color: "#c0c0c0",
                fontSize: 12,
                padding: [2, 0, 0, 0]
              }
            },
            "show": true,
            "position": "right",
            "fontSize": "15",
          },
          
          itemStyle: {
            color: function (params) {
              const name = params.data.name;
              if (name === 'Revenue' || name === 'Gross Profit' || name === 'Operating Income' || name === 'Pretax Income' || name === 'Net Income') {
                return 'green';
              } else if (name.includes('Expense') || name.includes('Cost')) {
                return 'red';
              } else {
                return 'blue';
              }
            }
          },
        }
      ],
      // Adding the footer
      graphic: [
        {
          type: 'text',
          left: 'center',
          bottom: 10,
          style: {
            text: 'Created by Spyder Academy',
            fill: '#c0c0c0',
            fontSize: "15"
          }
        },
        {
          type: 'image',
          left: 'center',
          bottom: 30,
          style: {
            image: '/images/logo.png',
            width: 50,
            height: 50
          }
        },
        {
          type: 'image',
          left: 'center',
          top: 40,
          style: {
            image: `/images/logos/${quarterlyEarnings.ticker}.png`,
            width: 50,
            height: 50
          }
        }
      ]
    };

    // Use the specified chart configuration
    chart.setOption(option);

    // If on mobile, convert the chart to PNG
    setTimeout(() => {
          const base64 = chart.getDataURL({
            type: 'png',
            pixelRatio: 2,
            backgroundColor: '#fff'
          });

          // Hide the chart and show the image
          $('#sankey_chart').hide()
          const imgElement = $('#sankey_image');
          imgElement.attr("src", base64);

          $(".sankey_container").attr("style", "width: 100%;")
        }, 1000); // Delay to ensure the chart is rendered
  }

  // Render the chart
  renderChart();
</script>



